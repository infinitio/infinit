import drake

from itertools import chain

with open(str(drake.path_source('../../elle/drake-utils.py')), 'r') as f:
  exec(f.read(), globals(), globals())

build = None
check = None
install = None

def configure(
    python,
    bottle,
    mongobox,
    elle,
    meta,
    python_common,
    production_build,
):
  global build, check, install

  if python is not None:
    git = drake.git.Git()
    version = drake.node(
      'lib/python/infinit/oracles/sisyphus/version.py')
    PythonVersionGenerator(version, git = git,
                           production_build = production_build)

    sources = drake.nodes(
      'src/infinit/oracles/sisyphus/__init__.py',
      'src/infinit/oracles/sisyphus/boulders/__init__.py',
      'src/infinit/oracles/sisyphus/boulders/drip.py',
      'src/infinit/oracles/sisyphus/emailer.py',
    )

    build = drake.Rule('build')
    build_python_path = drake.Path('lib/python')
    sources_built = drake.copy(sources, build_python_path, 'src')
    sources_built.append(version)
    elle_python = drake.copy(elle.elle.python, '.', '../../elle/elle')
    for source in sources_built:
      source.dependencies_add(elle_python)
    sisyphus = drake.python.Package(
      'python',
      build_python_path,
      sources_built + drake.copy(python_common, '.', '..') + drake.copy(bottle, build_python_path, True) + [version])
    build_binary = drake.copy(drake.node('sisyphus'), 'bin')
    build << sisyphus
    build << build_binary

    check = drake.Rule('check')
    for name in (
        'boulders/drip/accept-reminder',
        'boulders/drip/confirm-signup',
        'boulders/drip/delight-ghost',
        'boulders/drip/delight-recipient',
        'boulders/drip/delight-sender',
        'boulders/drip/ghost-reminder',
        'boulders/drip/onboarding',
        'boulders/drip/weekly-report',
    ):
      test = drake.node('tests/%s' % name)
      for source in sources_built:
        test.dependency_add(source)
      test.dependency_add(drake.node('tests/boulders/drip/utils.py'))
      test.dependency_add(meta)
      test.dependency_add(mongobox)
      runner = drake.Runner(
        test,
        env = {
          'PYTHONPATH': ':'.join(map(str, chain((drake.path_build(build_python_path / 'infinit/oracles'),), meta.pythonpath, mongobox.pythonpath)))
        })
      runner.reporting = drake.Runner.Reporting.on_failure
      check << runner.status

    install = drake.Rule('install')
