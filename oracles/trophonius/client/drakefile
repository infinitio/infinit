import drake
import drake.cxx
import drake.cxx.boost

build = None
check = None
install = None
config = None
lib = None

def configure(elle,
              reactor,
              transaction_lib,
              boost = None,
              python3 = None,
              prefix = drake.Path('/usr/local'),
              cxx_toolkit = None,
              cxx_config = None):

  global build, check, install, config, lib

  cxx_toolkit = cxx_toolkit or drake.cxx.Toolkit()
  cxx_config = cxx_config or drake.cxx.Config()

  local_cxx_config = drake.cxx.Config(cxx_config)
  local_cxx_config += elle.config
  local_cxx_config += reactor.config
  local_cxx_config.add_local_include_path('src')

  build = drake.Rule('build')
  install = drake.Rule('install')

  ## ------- ##
  ## Library ##
  ## ------- ##

  sources = drake.nodes(
    'src/infinit/oracles/trophonius/Client.cc'
    'src/infinit/oracles/trophonius/Client.hh',
    'src/infinit/oracles/trophonius/Client.hxx',
  )

  elle_lib = drake.copy(elle.lib_dynamic, 'lib',
                        elle.lib_dynamic.name().dirname())
  reactor_lib = drake.copy(reactor.lib_dynamic, 'lib',
                           reactor.lib_dynamic.name().dirname())
  transaction_lib = drake.copy(transaction_lib, 'lib',
                               transaction_lib.name().dirname())

  lib_cxx_config = drake.cxx.Config(local_cxx_config)
  lib_cxx_config.lib_path_runtime('../lib')
  lib = drake.cxx.DynLib('lib/trophoniusclient',
                         sources + [reactor_lib, elle_lib, transaction_lib],
                         cxx_toolkit,
                         lib_cxx_config)

  config = lib_cxx_config

  build << lib

  ## ------ ##
  ## Python ##
  ## ------ ##

  if python3 is not None:
    python_sources = drake.nodes(
      'src/infinit/oracles/trophonius/python.cc',
    )

    meta_python_cxx_config = drake.cxx.Config(local_cxx_config)
    meta_python_cxx_config += python3
    meta_python_cxx_config += boost.config_python()
    meta_python_cxx_config.lib_path_runtime('..')
    meta_python = drake.cxx.Module(
      'lib/python/infinit/oracles/trophonius/client',
      python_sources + [lib],
      cxx_toolkit,
      meta_python_cxx_config)
    build << meta_python

  ## ----- ##
  ## Check ##
  ## ----- ##

  check = drake.TestSuite('check')
