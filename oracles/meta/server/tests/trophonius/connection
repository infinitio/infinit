#!/usr/bin/env python3

from utils import Meta, User
from infinit.oracles.meta import error
from uuid import uuid4


with Meta() as meta:
  bob = User(meta, 'bob@infinit.io')
  alice = User(meta, 'alice@infinit.io')
  bob.login()
  alice.login()

  tropho = uuid4()
  assert not bob.connected

  tropho_params = {
    'port': 23456,
    'port_client': 0,
    'port_client_ssl': 0,
  }
  assert len(meta.get('trophoniuses')['trophoniuses']) == 0
  meta.put('trophonius/%s' % tropho, tropho_params)
  assert len(meta.get('trophoniuses')['trophoniuses']) == 1
  meta.delete('trophonius/%s' % tropho)
  assert len(meta.get('trophoniuses')['trophoniuses']) == 0

  meta.put('trophonius/%s' % tropho, tropho_params)

  res = bob.put('trophonius/%s/users/%s/%s' % (str(tropho), bob.id, str(bob.device_id)))
  assert res['success']

  res = bob.get('user/self')
  assert len(res['connected_devices']) == 1
  assert str(bob.device_id) in res['connected_devices']

  res = bob.delete('trophonius/%s/users/%s/%s' % (str(tropho), bob.id, str(bob.device_id)))
  assert res['success']

  res = bob.get('user/self')
  assert len(res['connected_devices']) == 0
