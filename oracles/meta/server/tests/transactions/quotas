#!/usr/bin/env python3

import datetime

from utils import Meta, User, throws
import infinit.oracles.meta.server.transaction_status as transaction_status

import bson

with Meta() as meta:
  alice = User(meta, "alice@infinit.io")
  alice.login()
  # Send to ghost size limit
  throws(lambda:
      alice.sendfile("bob@infinit.io", total_size = 5000000000),
      403)
  # Link quotas
  meta.database.users.update({'accounts.id': 'alice@infinit.io'},
    {'$set': { 'quota.total_link_size': 1000}})
  link = alice.getalink()
  alice.link_update(link, transaction_status.FINISHED)
  # server is updating quota by reading cloud storage file size, emulate that
  meta.database.users.update({'accounts.id': 'alice@infinit.io'},
    {'$inc': {'total_link_size': 1100}})
  meta.database.links.update({'hash': link['hash']},
    {'$set': {'file_size': 1100}})
  throws(
    lambda: alice.getalink(),
    403)
  # user erases one, below quota now
  alice.link_update(link, transaction_status.DELETED)
  link = alice.getalink()
  alice.link_update(link, transaction_status.FINISHED)


  bob = User(meta, 'bob@infinit.io')
  bob.login()
  me = bob.me
  assert me['plan'] == 'basic'
  assert me['features']['nag']
  assert me['features'].get('turbo') is None
  assert me['quota']['total_link_size'] == 1e9
  print(me['id'])
  meta.meta.change_plan(bson.ObjectId(me['id']), 'premium',
                        datetime.datetime.now() + datetime.timedelta(30))
  me = bob.me
  assert me['plan'] == 'premium'
  assert me['features'].get('nag') is None
  assert me['features'].get('turbo')
  assert me['quota']['total_link_size'] == 5e10
  meta.meta.change_plan(bson.ObjectId(me['id']), 'basic')
  me = bob.me
  assert me['plan'] == 'basic'
  assert me['features']['nag']
  assert me['features'].get('turbo') is None
  assert me['quota']['total_link_size'] == 1e9